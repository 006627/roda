language: java
jdk:
- oraclejdk8
sudo: required
install: true
services:
  - docker

env:
 global:
 - MAVEN_OPTS="-Xms1024m -Xmx4g -Dmaven.repo.local=$HOME/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
 - MAVEN_CLI_OPTS="--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
 # DOCKER_USERNAME
 - secure: "K23OtDvjFOuxGedcv7Y3kiu2XtpGDwLO0FWN0eieFzjlMHZU1k/whRMD41FhN89ocjKMI5pEQFIzPlETzq+ZxZa/YtQL7spcif4Q3ppe9RXfG6uUdgfFHpP5IUnpnDN8jqX3yRc+W371H3726s3s+LzoP/ANILd/WQP9rzXd8Ts="
 # DOCKER_PASSWORD
 - secure: "gDM83kopiEhqJfP9bEMSFmqAnbfLU+HInDpvZ8LQBZ2kA/0CjXCmcm4St/R70FJxd2iFo6YRUl6olPCpmuk4XJ9YSaRBtKcP2QV0tcxjLmtGlS3N6fsuLWn87Q/GUAdE30sp71fo47FAmdcfL68UzK0UgQcqZIKeZZ288ScrbIc="
 # GITLAB_RODA_DEV_TRIGGER
 - secure: "q3J6RREQFMDIPZ1e2G5V7yP/9Oxt6v/O7lZ8B3bEBvrE0NRg0fvoNSi2G3Qqq7CyXbt1BbJkfO1iGREBqOr3vOYsa9eYkF9jfInf+hivRn3jLTLMpGb9PWgjXYDxz3EFaIVBpgcnh2hyOowN7S4flD2vo2dMaCo+RbTwf0yyoMs="
 # GITLAB_RODA_DEV_TRIGGER_TOKEN
 - secure: "oeN++dcM4qph7ZKovkbj8nxS0PGibotwdlmWABGr9Q3IllvKmI1wt5PTwqVmbN2+1tbobaeZX6HoJ4b77QWaPRqk/56sBrYj/xnQhRoPDW/Oq6nqlpTm08wfrIExeDfxpZ5DiQBoXDoIYo4N17gxdXdPKLDQa6M29Ev7lryunvk="

addons:
  sonarqube:
    organization: "keeps"
    token:
      secure: "On53R35PWhHE5kJZophSGhiyfU3w/df/TgdVObsw1N64LGaGXiQQxaYuaYRTYT34SQHuZPRqpV84L8QMW5WGDEwH3EhaN3I3on1w6djrQ4lqk0+2yrqHtKkhL5+hByC50UQcdLoX84q6Ri6A570/tpNhT+/GnT2+1deJ5C+fjiU="
    branches:
      - master
      - development

before_script:
- curl https://bintray.com/user/downloadSubjectPublicKey?username=bintray | sudo apt-key add -
- echo "deb http://dl.bintray.com/siegfried/debian wheezy main" | sudo tee -a /etc/apt/sources.list
- sudo apt-get -qq update
- sudo apt-get -qq install siegfried -y
- sudo sf -update
- sudo apt-get -qq install clamav clamav-daemon -y
- sudo freshclam

script:
  - mvn $MAVEN_CLI_OPTS -Dtestng.groups="travis" -Denforcer.skip=true -Proda-wui-docker clean org.jacoco:jacoco-maven-plugin:prepare-agent install sonar:sonar

cache:
  directories:
    - $HOME/.m2/
    - $HOME/.sonar/cache

notifications:
  slack:
    secure: Hg2xvznD2QGhbCHRXN9DFM6dYIfeiZStj0Ud+OBS2swX9YOM77ufbDkMWF/yAAwxNg45QIC3a3okVy6TLzY5hA/PSKlc/5/ClujgRy02HLXlbYZ9psQH22/VFrER3uFkIpvMPhrxh3NLo/UMWfwvmwq26ziFnW4W6UDn/XXCHPE=

after_success:
  - bash <(curl -s https://codecov.io/bash)
  - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  - |
    if [ "$TRAVIS_BRANCH" == "master" ]; then
      export DOCKER_TAG="latest"
      export RODA_DEV_BRANCH="master"
    elif [ "$TRAVIS_BRANCH" == "staging" ]; then
      export DOCKER_TAG="$TRAVIS_BRANCH"
      export RODA_DEV_BRANCH="staging"
      docker tag keeps/roda:latest keeps/roda:$TRAVIS_BRANCH
    elif [ "`echo $TRAVIS_BRANCH | egrep "^v[2-9]+" | wc -l`" -eq "1" ]; then
      export DOCKER_TAG="$TRAVIS_BRANCH"
      export RODA_DEV_BRANCH="master"
      docker tag keeps/roda:latest keeps/roda:$TRAVIS_BRANCH
    fi
  - |
    if [ ! -z $DOCKER_TAG ]; then
      docker push keeps/roda:$DOCKER_TAG
      curl -# -o /dev/null -L --request POST --form ref=$RODA_DEV_BRANCH --form token=$GITLAB_RODA_DEV_TRIGGER_TOKEN --form "variables[DOCKER_TAG]=$DOCKER_TAG" $GITLAB_RODA_DEV_TRIGGER
    fi
